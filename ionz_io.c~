#include "ion.h"


/** 
 * Convert 3D-fftw_real array to 1D-float array. This is used
 * to simplify MPI transfer process. 
 *
 * @param input 3D-fftw_real array input
 * @param output 1D-float array output
 * @param N1 1st dimension grid number
 * @param N2 2nd dimension grid number
 * @param N3 3rd dimension grid number
 */
void pack_3d_array_mpi_transfer(fftw_real ***input, float *output, int N1, int N2, int N3) { 
  int ii,jj,kk;
  for(kk=0;kk<N3;kk++)
    for(jj=0;jj<N2;jj++)
      for(ii=0;ii<N1;ii++)
	output[kk*N2*N1 + jj*N1 + ii] = input[ii][jj][kk];
}

/** 
 * Convert 1D-float array to 3D-fftw_real array. This is used
 * to simplify MPI transfer process. 
 *
 * @param input 1D-float array input
 * @param output 3D-fftw_real array output
 * @param N1 1st dimension grid number
 * @param N2 2nd dimension grid number
 * @param N3 3rd dimension grid number
 */
void unpack_3d_array_mpi_transfer(float *input, fftw_real ***output, int N1, int N2, int N3) {
  int ii,jj,kk;
  for(kk=0;kk<N3;kk++)
    for(jj=0;jj<N2;jj++)
      for(ii=0;ii<N1;ii++)
	output[ii][jj][kk]=input[kk*N2*N1 + jj*N1 + ii];
}

/** 
 * Convert 1D-float array to 3D-fftw_real array. This is used
 * to simplify MPI transfer process. 
 *
 * @param input 1D-float array input
 * @param output 3D-fftw_real array output
 * @param Nion Number of the choices of total reionizing photons/neutral baryon
 * @param N1 1st dimension grid number
 * @param N2 2nd dimension grid number
 * @param N3 3rd dimension grid number
 */
void pack_4d_array_mpi_transfer(fftw_real ****input, float *output, int Nnion, int N1, int N2, int N3) { 
  int ii,jj,kk,jk;
  for(jk=0;jk<Nnion;jk++)
    for(kk=0;kk<N3;kk++)
      for(jj=0;jj<N2;jj++)
	for(ii=0;ii<N1;ii++)
	  output[jk*N1*N2*N3 + ii*N1*N2 + jj*N1 + ii] = input[jk][ii][jj][kk];
}
void unpack_4d_array_mpi_transfer(float *input, fftw_real ****output, int n_nion,int n1, int n2, int n3) {
  int ii,jj,kk,jk;
  for(jk=0;jk<n_nion;jk++)
    for(kk=0;kk<n3;kk++)
      for(jj=0;jj<n2;jj++)
	for(ii=0;ii<n1;ii++)
	  output[jk][ii][jj][kk]=input[jk*n1*n2*n3 + kk*n1*n2 + jj*n1 + ii];
}

/* Read density in cubep3m format (Fortran binary) */
/* The output will be the mass of baryons in cubep3m grid mass */


void read_density(char *filename, float *buffer_3d, double *robar_p, int N1, int N2, int N3, float vomegam, float vomegab) {  
  int ii;
  int n1,n2,n2;
  FILE *inp;
  // printf("start read_density\n");
  inp=fopen(filename,"rb");
  *robar_p=0.;
  fread(n1,sizeof(int),1,inp);
  fread(n2,sizeof(int),1,inp);
  fread(n3,sizeof(int),1,inp);
  if(n1 != N1 || n2 != N2 || n3 != N3) {
    printf("Grid dimensions in %s are not the same as in config file\n",filename);
    printf("Density file: %d:%d:%d   Config file: %d:%d:%d\n",n1,n2,n3,N1,N2,N3);
    printf("Terminate\n");
    exit(1);
  }
  fread(buffer_3d,sizeof(float),n1*n2*n3,inp);
  fclose(inp);
  
  for(ii=0;ii<n1*n2*n3;ii++) {
    buffer_3d[ii] *= vomegab/vomegam;
    *robar_p += buffer_3d[ii];
  }
  *robar_p /= (1.*(n1)*(n2)*(n3));
}

#ifdef XH_HISTORY
void read_xfrac(char *filename, buffer *buffer_4d, int Nnion, int N1, int N2, int N3) {
  FILE *inp;
  int ii,jk;
  int n1,n2,n3;
  inp=fopen(filename,"rb");
  fread(&n1,sizeof(int),1,inp);
  fread(&n2,sizeof(int),1,inp);
  fread(&n3,sizeof(int),1,inp);
  if(n1 != N1 || n2 != N2 || n3 != N3) {
    printf("Grid dimensions in %s are not the same as in config file\n",filename);
    printf("Xfrac file: %d:%d:%d   Config file: %d:%d:%d\n",n1,n2,n3,N1,N2,N3);
    printf("Terminate\n");
    exit(1);
  }
  fread(buffer_4d,sizeof(float),n1*n2*n3,inp);
  fclose(inp);
}
#endif

/* Read source in C2Ray like */
/* The output will be the SFR in cubep3m grid mass/year */
void read_sources(char *filename, float *buffer_3d, double *robarhalo_p, int N1, int N2, int N3) {
  FILE *inp;
  int ii,jj,kk,ll;
  int n1,n2,n3;
  float dt = 11.6e6;
  
  inp=fopen(filename,"rb");
  *robarhalo_p=0.;
  fread(&n1,sizeof(int),1,inp);
  fread(&n2,sizeof(int),1,inp);
  fread(&n3,sizeof(int),1,inp);
  if(n1 != N1 || n2 != N2 || n3 != N3) {
    printf("Grid dimensions in %s are not the same as in config file\n",filename);
    printf("Source file: %d:%d:%d   Config file: %d:%d:%d\n",n1,n2,n3,N1,N2,N3);
    printf("Terminate\n");
    exit(1);
  }
  fread(buffer_3d,sizeof(float),n1*n2*n3,inp);
  fclose(inp);
  for(ii=0;ii<n1*n2*n3;ii++) {
    buffer_3d[ii] *= dt;
    *robarhalo_p += buffer_3d;
  }
  *robarhalo_p /= (1.*(n1)*(n2)*(n3));
}

